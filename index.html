<script>
let history = [];

/* LOGIN */
function unlock() {
  const pass = document.getElementById("passCode").value;
  if (pass.toLowerCase() === "mujtaba") {
    document.getElementById("loginOverlay").style.display = "none";
  } else {
    alert("Access Denied");
  }
}

/* NAV */
function switchPage(pageId, btn) {
  document.querySelectorAll(".page").forEach(p => p.classList.add("hidden"));
  document.getElementById(pageId).classList.remove("hidden");

  document.querySelectorAll(".nav-btn").forEach(b => {
    b.classList.remove("bg-indigo-50", "text-indigo-700", "font-semibold");
    b.classList.add("text-slate-600");
  });

  btn.classList.add("bg-indigo-50", "text-indigo-700", "font-semibold");
}

/* CHAT */
async function sendChat() {
  const input = document.getElementById("userInput");
  const message = input.value.trim();
  if (!message) return;

  appendMsg(message, "user");
  input.value = "";

  const loadingId = "loading-" + Date.now();
  appendMsg("Thinking…", "ai", loadingId);

  const reply = await callAI(message);
  document.getElementById(loadingId).innerText = reply;
}

/* API CALL */
async function callAI(prompt) {
  try {
    const res = await fetch("/api/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt, history })
    });

    const data = await res.json();

    if (data.error) {
      return "❌ " + data.error;
    }

    history.push(
      { role: "user", parts: [{ text: prompt }] },
      { role: "model", parts: [{ text: data.reply }] }
    );

    return data.reply;

  } catch (err) {
    return "❌ Network error";
  }
}

/* UI MESSAGE */
function appendMsg(text, sender, id = null) {
  const win = document.getElementById("chat-window");

  const wrap = document.createElement("div");
  wrap.className = sender === "user" ? "flex justify-end" : "flex justify-start";

  const bubble = document.createElement("div");
  bubble.className =
    sender === "user"
      ? "bg-indigo-600 text-white p-3 rounded-2xl rounded-br-none max-w-[85%] text-sm"
      : "bg-white border p-3 rounded-2xl rounded-bl-none max-w-[85%] text-sm";

  if (id) bubble.id = id;
  bubble.innerText = text;

  wrap.appendChild(bubble);
  win.appendChild(wrap);
  win.scrollTop = win.scrollHeight;
}
</script>
